-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
SEIB-DGVM Update History (Last modified 17 May 2016)
by Hisashi SATO (JAMSTEC)
http://seib-dgvm.com/

If you need further explanation for these changes,
please refer to the model description document,
which is included in the SEIB-DGVM distribution package
-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

****** ver2.80 -> ver2.81 ******
(1) Bug Fix1
There are bugs for referring out of bounds for array variables.
I fixed them.

(2) Bug Fix2
Line 95 of the physics.f90
For the variable "dlen", which is the day length in a day, we set the maximum value 24.0.

(3) Bug Fix3
* Line 286 of the module.f90
   Before: x = 2060.0 * ((ALM3(pft)/1000000.0)**1.036) * ((dbh*100)**2.179) 
   After : x = 207.0 * ((ALM3(pft)/1000000.0)**1.036) * ((dbh*100)**2.179) 
This error makes African-woody-PFTs much shorter that they have to be. But, it would not deliver essential effects on the simulation result except canopy height. This is because SEIB-DGVM assumes only African-woody-PFTs can establish in the African continent, and thus its influences on competition among trees should be limitted.



****** ver2.71 -> ver2.80 ******
(1) Modification in the model structure
* I added a new function so that each simulation-run can refer unique random table. To enable this function, the newly introduced parameter "Flag_randomization" in the parameter.txt must be set to "true".

* Annual mortalities of trees as a result of bio-climatic limits and as a result of other factors are assumed to be 0.1 (previously they were assumed to be 1.0). Those mortalities corresponds to variables "mort_lim" and "mort_etc" in the metabolic.f90. These modifications are for avoiding too much perturbations in plant population dynamics.

* In the subroutine "leaf_season", I added a local parameter "Days_foliation_max", which is the maximum foliation period (in days) for deciduous woody PFTs. I am tentatively giving 300 for the parameter. This modification is for stabilizing their phenology.

* In the calculation of the foliation date for woody PFTs TeBS and BoBS, a constraint with latitude was introduced. This is for stabilizing their phenology.

* A local parameter Delay_from_foliation in the subroutine growth_trunk (metabolic.f90) was changed to 0 from 21.
With this change, trunk growth begins immediately after dormant period. This change is for avoiding huge CO2 emission due to growth respiration on the day when trunk growth restarts.

* The leaf-out date of larch trees (BoNS) is re-parameterized as the date when both of the followings two conditions are satisfied: 'soil temperature at 10cm becomes greater than 5C' and 'accumulated daily mean air temperature becomes greater than 100 C the day after the daily mean air temperature is beyond 0 C'. We took this parameterization from the following literature
Yamazaki, T., et al. (2007). "Flux variation in a Siberian taiga forest near Yakutsk estimated by a one-dimensional model with routine data, 1986-2000." Hydrological Processes 21(15): 2009-2015.

* A local parameter Days_release_larch in the subroutine leaf_season (metabolic.f90) was changed to 14 from 7.
This is because Nikolaeva et al. (2004) mentioned as follows: "quick reaching of Amax in two weeks following the leafing but before full needle expansion, which is considered"
Nikolaeva, N. V., T. C. Maximov, and A. P. Maximov (2004), Diurnal photosynthesis of larix cajanderi in central Yakutia, Proceedings of the International Semi-Open Workshop "C/H2O/Energy Balance and Climate over Boreal Regions with Special Emphasis on Eastern Eurasia", 43-45.

* Parameter ALM4 for PFT9 (Temperate Deciduous Broadleaves woody PFT) was changed to 0.38 from 0.20. This is for unifying the parameter value the PFT8 (Temperate Evergreen Broadleaves woody PFT).

* @Line315 of physics.f90 (Within the Subroutine waterbudget)
I corrected the equation to calculate vaporization heat at 1atm. Previous equation assumes that no vaporization occurs until water temperature reaches to 100 C. I thanks for Dr. Taro NAKAI (Nagoya Univ.) for pointing out this mistake.
   Before: lh = 2259 + 4.184 * (100-tmp_air)
   After : lh = 2500.25 - 2.365 * tmp_air   ! Fritschen and Gay (1979)

* @L322 of physics.f90 (Within the Subtourine waterbudget )
The psychrometer constant is replaced by the psychrometer coefficient, which is a function of air pressure and latent heat of water vaporization.

* @L1765 of metabolic.f90 (Within the subroutine decomposition)
For calculating decomposition rate of soil organic matters, the new code refers daily mean temperature of the top soil layer. The previous code referes to the monthly mean temperature (this is because this subtourine was called once in a month in the early versions).

* Some metabolic parameters are changed for larch trees (BoNS). For example, Pmax and SLA are related with the values taken from the following publication. Detailed explanation will be appered on the paper we are preparing.
Koike, T., et al. (2000). "Photosynthetic characteristics of Dahurian larch, Scotch pine and white birch seedlings native to eastern Siberia raised under elevated CO2." Eurasian Journal of forest research 1: 31-37.

* For GS_b2 (the Leuning parameter for stomatal conductance), I gave 9.0 for all woody PFTs and 2.0 for all grass PFTs. This is the result of careful survey of literature.

(2) Modifications in the I/O (input and output)
* Now the model can read a forcing file for time-series of the atmospheric CO2 concentration. Its file name should be given to the parameter "Fn_CO2" in the "parameter.txt".

* I changed the format of an output file "output.txt", which is for inputting the SEIB-Viewer. With this change, it cannot be visualized with older versions of the SEIB-Viewer.

* I deleted the variable bowen_ratio, which stands for the Bowen ration, because its computation method contained some deficit.


(3) Other technical modifications
* In the previous codes, following variables, all of which are function of only latitude and day of year, are computed every simulation. For efficient computation, this code compute them only once at the beginning of the simulation.
   sl_hgt           (solar hight at midday)
   dlen             (day length)
   rad_stratosphere (shortwave radiation at the atmosphere-top)
  
* For efficient computation, SEIB calculates photosynthesis rate for each of 10 PAR (Photothynthesis Active Radiation) class. Instead of directory writing the number "10" in the code as was in the previous versions, I give it to a newly introduced constant "MaxParClass", which is defined in the module.f90.

* In the previous versions, variables "radnet_vege" and "radnet_soil" are, respectively, defined as canopy and soil surface net radiations at the MIDDAY. From this version, they are provided values of the DAYTIME means. This is for simplifying the code for calculating transpiration and evaporation

* We introduced new global variables "radnet_long" and "albedo_mean" for our convenience. Their definitions are written in the "module.f90". These variables are written in an output file "output_netradiation.txt".

* In the subroutine "photosynthesis_condition", we introduced the following limiter.
i = min(max(i,1),MaxParClass)
Without this feature, daily GPP can be a vast value under simulations with G95.

* In the subroutine metabolic.f90, we deleted a local parameter Frac_resp_dormant (Fraction of maintenance respiration rate during dormant phase to growth phase for grass PFTs), which has been was not activated.

* @Line 23 of module.f90
I introduced new parameter, which defined the number of soil layers


(4) Bug Fix
* Line 442 of the output.f90
   Before:  sum(flux_ic_RunningRecord(:)), ',', & !19 Runoff (mm year-1)
   After:   sum(flux_ro_RunningRecord(:)), ',', & !19 Runoff (mm year-1)
This bug write intercepted precipitation instead of runoff-water in the output_annual.txt. This bug does not affect simulation itself



****** ver2.70 -> ver2.71 ******
(1) Bug fix @subroutine establish in the line 102 of population_regu.f90
Before
if ( Life_type(p) == 5 ) then; est_capacity(p)=.false. ;endif

After
if ( Life_type(p)==5 .and. Phenology_type(p)==0 ) then; est_capacity(p)=.false. ;endif

Due to this bug, no Tropical Deciduous Woody PFTs can establish outside of the African continent.

(2) Bug fix @subroutine output_cflux in Lines 719~720 of output.f90
Before
sum(gpp_RunningRecord (:,1)) * unit_conv ,',', & !GPP
sum(npp_RunningRecord (:,1)) * unit_conv ,',', & !NPP

After
sum(gpp_RunningRecord (1,:)) * unit_conv ,',', & !GPP
sum(npp_RunningRecord (1,:)) * unit_conv ,',', & !NPP

Due to this bug, simulated GPP and simulated NPP in the output_cflux.txt were not correctly outputted.



****** ver2.62 -> ver2.70 ******
(1) Modifications:
In this update, we reflected minor modifications during the last revising process of the Sato & Ise (2012), which tried to reproduce geographical distribution of vegetation structure and functions in the African continent. Basically, these modifications only affect simulations in the African continent only.

* Fire sub-model for the African continent was recalibrated (@Subroutine fire_regime2 in the population_regu.f90); we introduced a parameterization from Archibald et al (2009) for daily fire probability (which is denoted by the variable prob_fire in the code) as a function of crown coverage.

* For African woody PFTs, background mortality under poor-growth-year was changed; 10 times larger background-mortality will be applied if annual NPP was less than zero in the previous year.

* Computation method for the crown coverage of the virtual forest was changed from simplified method, which is denoted as "Method2" in the code, to higher accurate method, which is denoted as "Method1" in the code (@Subroutine crown_coverage in spatial_calc.f90). Note that we remain the "Method2" in the code as comment out lines.

* The soil conductance coefficient (C_soil_coefficient, which is definded in the subroutine waterbudget in the physics.f90) was recalibrated from 0.0030 to 0.0015.

(2) NOTEs:
Following modifications in the Sato & Ise (2012) was NOT reflected in the published code. This is for maintaining model-performance on the global scale.

* Criteria for biome determination were deeply modified in the Sato & Ise (2012).

* Value for a parameter F_inter was changed from 0.985 to 0.920 (in the parameter.txt). This is a result of calibration of soil carbon pool on the African continent.

* In the function to calculate the decomposition coefficients of soil carbon (@SUBROUTINE decomposition in the metabolic.f90), soil water content at saturation point (W_sat) was employed instead of soil water content at field capacity (W_fi). This is also a result of calibration of soil carbon pool on the African continent.



****** ver2.61 -> ver2.62 ******
(1) Changes in model specifications
* Fire sub-model
Previous versions assumed fuel moisture was same as moisture at the top soil layer (0-50 cm depth). The new version assumes fuel moisture is a half of moisture at the top soil layer. Fuel moisture determines probability of wild fire, and previous assumption rarely allows occurrence of wild fire. We may recalibrate this structure again in future.

* stat_water
Frozen soil layer is omitted in the calculation of the variable stat_water (state of water satisfactory, 0.0~1.0).

* Definition of ce_water has been changes as follows.
After : ce_water = 2*stat_water - stat_water^2
Before: ce_water = (stat_water)^(1/2)

* One of the default mortality conditions for trees have been simplyfied as follows.
After : A tree die if annual NPP of the previous year is less than  0 gDM
Before: A tree die if annual NPP of the previous year is less than 10 gDM

* Latent heat
Latent heat of a unit amount of water was assumed to be a constant in previous versions. In the new version, it is calculated as a function of air temperature. For further explanation, see line 262 of physics.f90 or P37 of the model description document.
Also, the labels "Latent heat" and "Sensible heat" in an output file were reversed. We fixed this mistake at the subroutine output_wflux.

* Recalibration of soil conductance coefficient
Above change in latent heat resulted in a reduction of evapotranspiration rate. So, soil conductance coefficient was recalibrated from 0.0015 to 0.005.

* We replaced saturation-point (W_sat) with field-capacity (W_fi) for the calculation of soil wetness.
  @Subroutine fire_regime
  After
     x = Frac_Moisture_litter * pool_w1_RunningRecord(1) / (Depth*W_fi)
     fire_factor = exp( -PI * ((x/moist_factor)**2) )

  Before
     x           = pool_w1_RunningRecord(1) / (Depth*W_sat)
     fire_factor = exp( -PI * ((x/moist_factor)**2) )

  @SUBROUTINE decomposition
  After
     x = (sum(pool_w(1:5))/5.0) / W_fi / Depth
     effect_mois = 0.25 + 0.75 * x

  Before
     x = (sum(pool_w(1:5))/5.0) / W_sat / Depth
     effect_mois = 0.25 + 0.75 * x

* Previous code allows African Woody PFTs (PFT number = 5 and 6) to establish outside of the African continent. We changed the rule so that they can only establish within African continent.

* The biome-classification-scheme have been simplified.

* Parameter change: Pmax, LA_max, RG_stock_out, and RG_stock_in, DivedG, and Frac_Stock of grass PFTs,

(2) Changes in program structures
* The new code reads time-series data of atmospheric CO2 at the beginning of the program. Now, time-series data of atmospheric CO2 during 1750 to 2100 can be referred in the new code, although default computation still employs the prescribed default CO2 concentration, which is given as CO2atm_default.

* Some command lines within the subroutine main_loop in previous versions were moved to newly introduced subroutines in etc.f90.

* Subroutines floor_radiation and spacial_limitation have been improved for their computation efficiency.

* Dimension structure of following array-variables have been changed for improving efficiencies of memory access:
  lai_opt_grass_RunningRecord
  phenology_RunningRecord
  npp_RunningRecord
  gpp_RunningRecord
  stat_water_RunningRecord
  mass_sum_RunningRecord



****** ver2.60 -> ver2.61 ******
(1) Bug fix @subroutine maintenance_resp in metabolic.f90
Lines 844 and 845 were switched. Due to this bug, trees were not demanded for payment of their maintenance-respiration cost, although it was added on the respiration recording variables. This bug was contaminated on version 2.50.

(2) Bug fix @subroutine direct_radiation in spatial_calc.f90
Some necessary procedures were deleted. This bug was contaminated on version 2.60.

(3) Bug fix @subroutine maintenance_resp in metabolic.f90
A variable Spinup_year was not initialized. This may cause failure for a continue run from spinup files.

(4) Bug fix @ parameter.txt
For the parameter "Depth", I gave a wrong value, 30. The Correct value for this parameter is 100. This bug was contaminated on version 2.60.



****** ver2.55 -> ver2.60 ******
(1) General Model Structure
[1-1] Climatic data
We changed the climatic-data format for inputting the model. Model can now input multi-year climatic data. When multi-year climate data was specified for inputting, then the model repeatedly uses all year's values.

As well, climatic data includes daily range of air temperature. This item is not used for any calculation in the current model, but we'll use it for the soil-hydrological process computations in future modifications.

To save the memory requirement, the new code interpolates soil temperature for each soil layer at main_loop, not at star_point as was previous code.

[1-2] Litter pools and fuel pools computations
Increment of litters pools and fuel pools are basically conducted in the main_loop by considering litter fluxes, which are computed in descendent subroutines. This modification is to simplify the code for managing varieties of litter pools and fuel pools.

[1-3] Other changes
When scenario 4 is selected for tree establishment (i.e., Est_scenario=4), there are two type of establishment; deterministic and stochastic. From the current version, no deterministic establishment occurs when there are only few trees (less than 100.0g DM/m2 of woody biomass). Refer Model_description.doc for more explanations.

A global variable stat_leaf was deleted, as it was not used any more.

(2) New PFTs
We assigned PFT 5 and 6 as African woody PFTs, which can only establish in the African continent (Life_type=5). These newly introduced PFTs share many features with other tropical woody PFTs; crown depth is given by ALM6 * tree height (m), maximum leaf area within a crown is computed by LA_max * crown cross-selection area, and foliation stops when NPP at the bottom of the crown layer is negative. For further descriptions of new PFTs, refer Model_description.doc and Sato & Ise (submitted).

(3) Fire regime
We changed computation frequency of fire regime from yearly to daily.

We introduced a new wildfire sub-model (subroutine fire_regime2 in population.f90), which is employed only for African continent. For other areas, previous wildfire sub-model is employed. The new sub-model was delivered from aDGVM (Scheiter and Higgins 2009, GCB) with some simplifications. Refer Sato & Ise (Submitted) for further explanations.

For computations in the new sub-model, we introduced two fire-ignition fuel pools, pool_fuel_standT and pool_fuel_standG (gDM stand-1). In the new sub-model, fire intensity is computed for each grass cell, and the fire intensity regulates tree mortality.



****** ver2.54 -> ver2.55 ******
Bug fix @ line959 of metabolic.f90

Wrong  :   stat_leaf(no) = stat_leaf(no) - (a2+a3) / max(0.01,x)
Correct:   stat_leaf(no) = stat_leaf(no) - (a1+a2) / max(0.01,x)

This bug was slipped into the code from version 2.30.



****** ver2.53 -> ver2.54 ******
In the cource of bug fixing in the last update, I deleted some neccessary procedures @ subroutine direct_radiation in spatial_calc.f90. I restored it. This was pointed out by Shouta ISHII of Tohoku university. Thanks!



****** ver2.52 -> ver2.53 ******
Bug fix @ subroutine direct_radiation in spatial_calc.f90
SEIB assumes that tree shadows over the edge of virtual forest enter from the opposite side of the virtual forest. This assumptions was not correctly coded. Also, an another bug for calculating shading was found. We fixed them.



****** ver2.51 -> ver2.52 ******
Bug fix @ subroutine establish in population_regu.f90

Following command is the line 180 in the previous code.
est_possibility(:) = est_possibility(:) / real( max(1, no_possible) )

This command have to be executed only when Est_scenario is 1 or 2.
Because, if Est_scenario is 3 or 4, and if more one woody PFT can establish, this command decreases total establishment rate of trees.
We have moved the above line to the appropriate place.



****** ver2.50 -> ver2.51 ******
(1) Bug fix @ subroutine crown_shake in spatial_calc.f90
This subroutine moves central locations of tree crown horizontally, and the previous code can move them outrange of the virtual forest.

(2) Bug fix @ subroutine ground_vacant in spatial_calc.f90
A variable patch_vacant, which indicates "safe patch" for tree establishment, was not accurately delivered.

(3) Bug fix @ subroutine mortality in population_regu.f90
A variable tree_crowded, which indicates degree of congestion for each tree, was underestimated. This bug should results in underestimation of over congestion mortality for tropical evergreen PFTs.

All of above bugs were pointed out by Yuji MORI. Thanks!



****** ver2.42 -> ver2.50 ******
(1) Changes in model structure
* An existing PFT (TrBR, previous PFT number 5) was replaced by following new PFTs
New PFT nubmer 5: Tropical broad-leaved evergreen (TrBE_5_Africa)
New PFT nubmer 6: Tropical broad-leaved raingreen (TrBR_Africa)
They were introduced for our current study that SEIB-DGVM is sophisticated to African continent. This study is underway and not yet published. Hece, we do not describe modifications that was conducted for these PFTs.

* Grass layer was horizontally dived by DivedG * DivedG, where DivedG is a newly introduced parameter. Each cell is the unit of grass simulation. Grass growth was computed by considering PAR intensity on top of each grass cell. Due to this modification, we introduced new variable par_grass_rel(DivedG,DivedG), which possesses relative PAR intensity on top of the each grass cells compared with the top of virtual forest. This variable is updated once in a week.

* Unlike previous code, the floor of the virtual forest is monopolized by one of the two grass PFTs, namely C3 and C4 grass. On the end of each year, dominant grass type is determined with criterion of Collatz et al. (1998).

* We introduced a new assumption that PFTs differ in the depth at which plant can absorb soil water. This depth was given by a newly introduced parameter, RootDepth. With this modification, computation method of stat_water and transpiration were changed.

* Definition of stat_water was changes for every PFT except larch (BoNS).

* Computation method for evaporation and transpiration were changed so that they can utilize soil layer 1~5. In accord with this change, computation method for c_soil was changes.

* Computation method for percolation was simplified. Current way of computation is similar to simple "bucket model". Preliminary simulation showed that this simplification did change the output so much.

* Computation interval for litter and SOM decomposition was changed from monthly to daily.

* Previously, litter decomposition rate was a function of actual evapotranspiration rate, soil temperature, and soil water content. Now, it is simply a function of soil temperature and soil water content. Due to this change, we introduced a new parameter TO_litter, which is the standard litter decomposition rate under moderate soil temperature (20 Celsius) and soil water content.

* Computation interval for trunk growth was changed from monthly to daily. Previously, all available resource was consumed at the end of the trunk growth procedure. This consumption causes lack of resource for maintenance respiration when daily photosynthesis rate is not enough. When trunk growth computation is frequent, this will cause a severe degradation on tree growth. To avoid this problem, we assumed that trunk growth leaves over 10.0 gDM of available resource per tree. This value can be modified by changing a local parameter, Mass_buffer, within the subroutine growth_trunc.

* The criterion for need for wet month for tree establishment was changed. For this change, we introduced a new global variable ev_pot_RunningRecord(1:365), which possesses 1 year running record of daily potential evapotranspiration, which is calculated by Priestley-Taylor model.

* Mortality due to heat stress was turned off for every PFTs.

* In the previous versions, length for foliation phase was taken into consideration for calculating maintenance cost of leaves. We abolished this assumption for simplifying the model and code.

* In the previous version, PAR_min, the minimum annual average of midday PAR for establishing of tree, was referred to the average value of whole forest. In the current version, this parameter was referred to the annual average for midday PAR computed for each establishment cell.

* Grass PFT: Values for parameter SLA and Pmax were returned to the original values of Sato et al. (2007). Modifications during development procedure were remained for these values with out mistake.

* Grass PFT: Previously, date of phenology change from dormant phase to growth phase was constrained by latitude. We abolished this constraint.

* C4 PFT: The value for GS_b2 of C4 grass PFT was changed to 5.0 from 2.0. This change intensifies dependency of C4 grass productivity on precipitation.


(2) Changes in technical issue
・Daily updated variables for photosynthesis condition of tree and grass were computed in different loops in the previous code. Now they are computed in the same loop.

・In the previous code, daily updated variables for photosynthesis condition of tree were computed for each tree using PAR intensity averaged over crown disks of the tree. In the current code, they were computed for every combination of PFT and 10 levels of PAR intensity. When computing photosynthesis for trees, these variable employed for each crown disk according to PFT and day-time-mean of PAR intensity. (@Subroutine photosynthesis_condition in metabolic.f90)

・Added output variables.
(@Subroutines output_annual, output_cflux, and output_wflux in output.f90)

・Classification of global variables was reorganized (@module.f90).
In accord with this, order of variables in spin-up file (i.e. resume file) was reorganized (@Subroutines spinup_in and spinup_out in etc.f90).

・"Call mortality" was relocated to the top of the annual computation for speed-up. (@Subroutine main_loop in main.f90)


(3) Changes in global variables and parameters
* Variables for last fire day (fire_clo), last leaf onset day (pheno_clo), and last leaf shedding day (pheno_cls) were replaced by newly introduced variables dfl_fire, dfl_leaf_onset, and dfl_leaf_shed, respectively. Previous variables record these days in absolute number of simulation-day-counter, and this way of recording often caused confusion. New variables record so that how many days pass from these phenomenon occurred.

* Array structure of the following variable was changed to meet with the dimension of grass cells.
gmass_leaf, gmass_root, gmass_available, gmass_stock, lai_grass, lai_opt_grass
lue_grass, co2cmp_grass, psat_grass, lai_opt_grass_RunningRecord, par_grass, par_grass_RunningRecord

* We introduced a new variable, fire_number, which records fire number from the start of simulation.

* We introduced a new variable, pool_c_RR, which possesses 1 yr running record of total carbon pool (biomass + soil carbon) in the virtual forest.

* In the previous code, values for parameters PN_s and PN_r were directly given on the code. Now, they are given on parameter.txt.

* We introduced a new parameter, Day_in_Year, which defines day number in a year. In the previous version, this value was directly written in the code.

* Variables tmp_ave_C3growth_RunningRecord and tmp_ave_C4growth_RunningRecord were reorganized into a variable, tmp_ave_GrassGrowth_RR.

* Variables c_uptake and c_emission were reorganized into running record for 1 year, flux_c_uptake_RR. In addition, c_emission was reorganized in to 4 variables(flux_c_mnt_RR, flux_c_gro_RR, flux_c_htr_RR, and flux_c_fir_RR), which differ in source of carbon emission.

flux_c_uptake_RR !carbon uptake   due to photosynthesis
flux_c_mnt_RR    !carbon emission due to maintenance   respiration
flux_c_gro_RR    !carbon emission due to growth        respiration
flux_c_htr_RR    !carbon emission due to heterotrophic respiration
flux_c_fir_RR    !carbon emission due to fire incident        

* A variable lai_opt_grass was deleted. Where this variable was used, new code refers lai_opt_grass_RunningRecord.

* A variable, type_grass, was deleted. Where this variable was used, new code refers variable pft_exist(C3g_no) or pft_exist(C4g_no).

* A variable, par_grass, was deleted. Where this variable was used, new code calculate "par * par_grass_rel".

* Variables gpp_month, npp_month, gpp_annual, npp_annual, and npp_10d_ave were deleted. Where these variables were used, corresponding values were calculated from running records gpp_RunningRecord and npp_RunningRecord.

* Variables pool_trunc, pool_leaf, pool_root, pool_grass_ag, and pool_grass_bg were deleted. They were not used in the code.

* Variables hyd_ro, hyd_ic, hyd_ev, and hyd_tr were replaced by newly introduced running records flux_ro_RunningRecord, flux_ic_RunningRecord, flux_ev_RunningRecord, and flux_tr_RunningRecord.

* A variable tmp_soil_month_ave (30days running average of tmp_soil) was deleted. Where this variable was used, corresponding variable was generated from tmp_soil_RunningRecord.

* A variable pool_litter (pool of litter carbon) was split into following 5 compartments.
pool_litter_trunk !litter pool in a stand (trunk of woody PFTs)    
pool_litter_leaf  !litter pool in a stand (leaves of woody PFTs)
pool_litter_root  !litter pool in a stand (fine root of woody PFTs)
pool_litter_ag    !litter pool in a stand (aboveground of grass)
pool_litter_bg    !litter pool in a stand (belowground of grass)

* Variables for flux litter (flux_litter_trunk, flux_litter_leaf, flux_litter_root) were recorded for individual trees in the previous version. They are aggregated into the variables for whole forest from current version.

* We introduced new variables sum_par_floor and sum_par_grass. They are annual sum of PAR intensity for establishment cell and grass cell, respectively.


(4) Bug fix
Tree mortality due to fire regime was not appropriately calculated. We fixed it.



****** ver2.41 -> ver2.42 ******
Through the revision processes of Sato, Kobayashi, and Derbart (in press), we have modified some structures and parameters of the model. This version up reflects these changes on the code and parameter file.

Notice: In simulations of Sato, Kobayashi, and Derbart (in press), bug fixes during the last release were not reflected.

(1) Added an assumption that larch establishment can only occurs during 50 years from forest fire.

(2) In the original model, tree can die through heat stress and negative annual primary production. We abolished these mortalities, which cause over kill of trees in the harsh environment of east-Siberia. Alternatively, for trees, of which annual NPP was less than 10g DM in the previous year, trunk growth is suspended for a year.

(3) @ subroutine growth_trunc in metabolic.f90
Diminishing factor for trunk growth of larch trees (PFT number 10) was changed.

(4) @ subroutine leaf_season in metabolic.f90
Period for stock resource consumption was shortened from 14 days to 7 days. This modification was conducted only for larch trees (PFT number 10).

(5) @ parameter.txt
Follwing parameters of larch trees (PFT number 10) were changes: Tmin, RGf, RGr, PARmin, LAmax.



****** ver2.40 -> ver2.41 ******
(1) Bug fix @subroutine main_loop in main.f90
A general usage variable, x, was not initialized, and thus I inserted initialization command on line 180. This bug affected a variable, stat_water, which regulate photosynthesis efficiency under water limited condition. Note that this bug has been available since version 2.30.

(2) Bug fix @subroutine climate_stat in ets.f90
Variables tmp_ave_C3growth_RunningRecord and tmp_ave_C4growth_RunningRecord were not correctly calculated. These variables represent mean air temperature during growth phase of C3 and C4 grass, respectively. SEIB assumes that the optimum temperature for photosynthesis is tuned to the 20 years running means of the above variables within specific ranges. This bug caused malfunctioning for this feature. Note that this bug has been available since version 2.00.
This bug was fixed as follows.

@line 46
(Fault)   a1     = a1 + tmp_air
(Correct) a1     = a1 + tmp_air_RunningRecord(i)

@line 49
(Fault)   a2     = a2 + tmp_air
(Correct) a2     = a2 + tmp_air_RunningRecord(i)



****** ver2.30 -> ver2.40 ******
(1) I took back the simplification for leaf turnover rate, which was conducted at the item (2) in the last update. This change only affects behavior of deciduous PFTs.

Leaf turnover rate in previous code (yr-1):
TO_f(p)

Leaf turnover rate in the new code (yr-1):
TO_f(p) - 365 / max(1,365-(pheno_clo(p)-pheno_cls(p)))

(2) I abolished the constraint for BoNS (Boreal Needle leaf Summer green woody PFTs) that no foliation occurs after 30 days from the leaf onset date. I also abolished the constraint for BoNS that no trunk growth occurs during first 121 days from leaf onset day.

(3) For all woody PFTs, I assumed that maximum daily increment of leaf area is 10% of crown surface area.

(4) Bug fix @subroutine growth_wood in metabolic.f90
In the leaf production of BoNS, I inappropriately programmed calculation method for the limitation of foliation due to allocation constraint. I fixed it.

(5) Bug fix @subroutine leaf_season in metabolic.f90
Metabolic cost for converting stock resource into available resource was not subtracted from mort_regu1 (NPP of each tree). I fixed it.

(6) Technical issue @subroutine leaf_season in metabolic.f90
We reorganized program flow.



****** ver2.20 -> ver2.30 ******
(1) To avoid complexity, we abolished a regulation that sapwood changes to heartwood when resource for maintenance respiration is sufficient. (@ SUBROUTINE maintenance_resp)

(2) To simplify the model, we abolished correction on leaf turnover rate, which exists in subroutines 'maintenance_resp' and 'turnover'. This change only affects behavior of deciduous PFTs.

Turnover rate in previous code (yr-1):
TO_f(p) - 365 / max(1,365-(pheno_clo(p)-pheno_cls(p)))

Turnover rate in the new code (yr-1):
TO_f(p)

(3) In the previous code, the minimum required PAR for establishment, PARmin, was compared to averaged PAR intensity on top of the grass layer. From this version, PARmin is compared to PAR on top of the grass layer of each 1×1-m grid cell.

(4) We changed some allometry and allocation formulations of TrBE. We also introduced gap formation mechanism, which only activates when biome type is classified as tropical rain forest. Refer our publication in future for detail.

(5) A minor bug within subroutine direct_radiation in spatial_calc.f90 was fixed. Shading intensities among trees were bit underestimated in the previous code.

(6) Another minor bug within Subroutine direct_radiation in spatial_calc.f90 was fixed. Previous code potentially causes error when angle of incoming direct radiation exceed 90 degree.

(7) We introduced a constraint that maximum crown diameters of trees cannot exceed a side length of the virtual forest. As we gave large maximum crown size for some of the woody PFTs in TrBE, such constraint is necessary to secure the stability of the program behavior.

(8) Parameters of plant functional types TrBE and BoNS were tuned again.



****** ver2.11 -> ver2.20 ******
(1) The major changes in this version exist in the hydrological sub-model. (a) Three soil layers have been changed into 30 soil layers, of which depth is equally 0.1m. (b) Computation method for soil infiltration and percolation has been simplified. The new model is an analog of simple bucket model. See model description file for detail. (c) Gradient of soil temperature is taken into consideration. This is an important property when we consider dynamics of active soil layer thickness in boreal region. Therefore, the new model requires soil temperatures at three soil depths. Input climate data has to be generated again in our website.

According to this change, following parameters concerning infiltration and percolation were deleted from 'module.f90', 'start_point.f90', and 'parameter.txt'; K0_infilt, K1_u_up, K2_u_up, K1_s_up, K2_s_up, K1_u_low, K2_u_low, K1_s_low, K2_s_low, K1_u_base, K2_u_base, K1_s_base, K2_s_base.

(2) Parameters were tuned again.

(3) Files for land properties were converted into one file 'land_prop.txt'



****** ver2.10 -> ver2.11 ******
Ooops, we fixed an error that we made in the last update. Equation A45 has been turned back to the previous form. Stomata should close during night...<br>
This change accompanies re-calibration of a tuning parameter for evaporation. The parameter that calculates c_soil (soil conductance for evaporation) in Equation A47 has been changed from 0.0010 to 0.0015.



****** ver2.00 -> ver2.10 ******
We corrected error in Penman-Monteith equation at subroutine 'waterbudget' on physics.f90. Equations for water vapor conductances (c_aero and c_soil) were also changed. This will influence evapotranspiration. For detail, refer 22 April 2008 report on the erratrum page at http://seib-dgvm.com/erratum.html



****** ver1.42 -> ver2.00 ******
In this major update, we modified calculations for TrBE and BoNS for appropriately reconstructing vegetation dynamics in Boreal needle-leaved summer green forest and Tropical rain forest. Here, we only describe modifications that is conducted for BoNS. Concerning modifications for TrBE, please refer to the paper, which will be published soon (hopefully). Note these modifications do not affect simuilations for other PFTs. To enable biome specific computations, woody PFTs in Tropical rain forest and Boreal larch forest are labeled using a parameter Life_type (Life_type=1 for TrBE and Life_type=2 for BoNS).

( 0 ) Abbreviations and variables
BoNS: boreal needle-leaved summer green trees
dbh : diameter at breast height (m)
ba  : stem basal area at breast height (m2)

( 1 ) New allocation and allometry equations for BoNS. Refer submitted manuscript for soruces.
(1-1) Maximum tree height (m) : 1 / (1/(165*dbh) + 1/31.7)
(1-2) Maximum crown area (m^2) : 80*dbh
(1-3) Crown depth (m) : min [10, tree_height]
(1-4) Needle dry weight (g) : 330 + 50580 * (dbh^2)
(1-5) Trunk dry weight (kg) : select larger value from the following equations
     1.5 (467*ba*10^4 - 11300)
     190*((100*dbh)^1.7) + 42.8*((100*dbh)^1.79) + 171*((100*dbh)^1.67)
(1-6) Sapwood diameter (m) : min [dbh, 0.0188]
(1-7) Resource for producing trunk is diminished by multiplying following reduction factor, which depends on dbh. This equation assumes that stem growth efficiency becomes lower when dbh approaches to its maximum limit at 0.5m. The reduced resource is consumed by maintenance respiration.
     1.0 - (dbh/0.5)^2

( 2 ) Leaf phenology of BoNS
(2-1) Foliation phase starts when sum of air temperature above 4.1 degree Celsius  from January 1 exceeds 65.
(2-2) Introduced new constraint; after 30 days from the leaf onset date, no foliation occurs.
(2-3) When daily mean air temperature becomes less than 4 degree Celsius for successive 7 days, dormance phase initiates.

( 3 ) Leaf phenology of all deciduous PFTs
(3-1) During the beginning 14 days of dormance phase, all leaves are transformed into litter at a constant rate. In the previous versions of our model, we did not assume this delay (i.e., all leaves transformed into litter within the first day of dormance phase).

(3-2) We introduced a new parameter RG_f_suck, which determines fraction of leaf biomass transformed into mass_available (available resource) at defoliation. This is PFT specific parameter. Currently, we assumed RG_f_suck=0.0 for all PFTs (i.e., no fraction of leaf biomass transformed to mass_available when defoliation)

( 4 ) New parameters for plant physiology and dynamics for BoNS
Refer submitted paper or included parameter file "parameter.txt".

( 5 ) Other physiological process
In the previous version of SEIB-DGVM, light-saturated photosynthetic rate psat, light-use efficiency lue and CO2 compensation point co2cmp were calculated for each PFT for each simulation day, assuming midday PAR over forest canopy. From this version, we refined this calculation by changing individual base, assuming mean PAR received for each tree crown.

( 6 ) Physical processes
(6-1) To represent roles of permafrost in the model, we modified soil water processes as follows. When soil temperature at 10cm depth is less than 0 degree Celsius, plants were inhibited to absorb soil water, and also soil water percolation from soil layer 1 to 2 was inhibited.
(6-2) When annual mean of soil temperature at 10cm depth is less than 0 degree Celsius, soil water percolation from soil layer 2 to 3 was inhibited.
(6-3) New set of aerodynamic conductance parameters (Roughness length, Zero plane displacement height, and Vegetation height）are applied for boreal deciduous forest and woodland (Biome type No.10).
(6-4) We assumed vapour pressure deficit on soil surface as 0.
(6-5) When we convert eK (light attenuation coefficient for actual sun direction) from EK0 (light attenuation coefficient for vertical direction), we multiplyed 0.86 to the sl_hgt (midday sun height).
Before: eK(p) = EK0(p) / min(1.0, max(0.3, sin(sl_hgt * DtoR)))
After : eK(p) = EK0(p) / min(1.0, max(0.3, sin(0.86 * sl_hgt * DtoR)))
The horizontal line of 0.86 * sl_hgt equally divides daily sum of solar radiation into two, when daily changes of solar angle and solar radiation are sin and sin2, respectively.

( 7 ) Technical change
(7-1) A parameter "Life_type" of BoNS was defined to be 2. The aim is introducing BoNS specific allocation, allometry equations, and etc.
(7-2) Frequency of calling subroutine "direct_radiation" has been changed to 14 days from 30 days. For increasing computation speed, just turn back it.
(7-3) Definition lines for global variables were aggregated using 'USE' sentence of Fortran90.
(7-4) Some of the subroutines were aggregated.
(7-5) The definition of value for some parameters (ex. Max_no, Dived) were moved to modules.f90 from parameter.txt.
(7-6) The output variables for output.txt were compressed. The aim is reduction of data size and reading time for SEIB-Viewer.

( 8 ) Bug Fix
Annual evapotranspiration, which determines litter decomposition rate, did not include intercepted water by canopy. We fixed it.



****** ver1.42 -> ver1.43 ******
These updates are just for avoiding possible technical problems under different computation sysmtes. We thank Dr. Jed Kaplan for testing our code under his computational system.

(1) Changed default value for parameter Max_no, which determines maximum tree number in a virtual forest, from 900 to 300. On some computation system without sufficient memory, the previous value can cause trouble.
(2) Changed subroutine name "main" to "main_loop". Under some Fortran compiler, the previous name can cause trouble.
(3) Changed dimension description form of variables from dimension(1:n) to dimension(n).
(4) Changed compression format from "LZH" to "ZIP", which is most commonly used all over the world.



-+-+-+-+-+-+-+- Below here, written in Japanese only -+-+-+-+-+-+-+-



****** ver1.41 -> ver1.42 ******
●SEIB-DGVM websiteで出力される気象データを利用することを可能にするため、これまで6つのファイルに分割されていた気象データを1つのファイルにまとめた。

●サブルーチンoutput_for_viewer（ファイルoutput.f90中）において、SEIB-Viewer用の草本バイオマス出力の単位が間違っていたので修正した。



****** ver1.40 -> ver1.41 ******
これまで熱帯性常緑広葉樹（TrBE）は１種類のみを仮定してたが、このバージョンから４種類に増やした。これら４種類のPFTは、パラメーターLife_typeに1を与えることによって区別し、他の木本PFTとは、適用させるアロメトリーなどの諸条件が変更されている。これらの変更の詳細は、現在準備中の論文がアクセプトされた後に記載する。この拡張と同時に、いくつかの重要なバグフィックスが行われたため、コードのみ先に公開する。

     ～ 修正した不具合 ～

●気孔抵抗の設定値を修正した（※重要！）。
気孔抵抗のパラメーター値GSb2に、異常に高い値が設定されていた。典型的な値として、5.0 hPaを全PFTに与えた（但し、C4草本については2.0を与えた）。
また、気孔抵抗のパラメーター値GSb3にも、異常に高い値が設定されていた。典型的な値として、10.0を全PFTに与えた。

詳細については、Leuning (1995)のTable 2を参照のこと。以下は、Sato et al (2007) と Leuning (1995)とのパラメーター値の対応表、および引用文献である。

[Sato et al 2007]           [Leuning 1995]
GSb1 (mol H2O m-2 s-1) --->  g0
GSb2                   --->  a1
GSb3 (h Pa)            --->  D0 (Pa)

Leuning R (1995), A critical appraisal of a combined stomatal-photosynthesis model for C3 plants. Plant Cell Environ. 18, 339-355.

この変更は気孔抵抗を高くするため、光合成速度を低下させてしまう。本来は全ての調整パラメーターを再調整するべきだが、簡単のため、全PFTの最大光合成速度（Pmax）を3.0 micro mol CO2 m-2 s-1 ずつ高くした（但し、C4草本は6.0高くした）。

●年ベースで計算しているリター分解速度を月ベースに変換する式にミスがあったため修正した。

●蒸散・発散過程によって、土壌含水量が負の値になってしまうことがあったため、これを修正した。

●変数par_grass_RunningRecordは、実はRunning Recordでなかったのを修正した（これを利用した計算に対しては影響しない構造であったが、後で何か問題を起こさないように修正した）

     ～ 機能拡張と変更 ～

●parameter.txtで指定されるPFT固有パラメーターLife_typeの定義を変えた。
Life_type = 0, 以下のカテゴリーに入らない木本PFT
Life_type = 1, 熱帯性常緑広葉樹
Life_type = 2, 寒帯性落葉針葉樹（カラマツなど）
Life_type = 3, C3草本
Life_type = 4, C4草本

●木本PFTの葉群DISKに直達光を分配させるルーチン（SUBROUTINE direct_radiation in apacial_calc.f90）を拡張し、任意の高さ以下の葉群に関しては、水平方向の平均直達高強度を入力させることで、計算量を節約できるようにした。この機能を使用・設定するためには、サブルーチン中で定義されているLocal parameterのHgt_thresの値を指定する。例えば、Hgt_thres=10と定義した場合には、鉛直10STEP以下の葉群DISKについては簡易計算が行われる。従って、この機能を使用しない場合には、サブルーチン中のHgt_thres=0（デフォルト値）と指定すること。

●これまでは南中時に森林上端へ入射されるPAR強度を元として（草本PFTについては南中時に草本レイヤー上端に入射される光条件を元として）、光合成の諸条件を算出していたが、これを、各木本個体の葉群に降り注ぐPARの日平均を元に、算出するようにした（草本PFTについては、草本レイヤー上端に一日平均で降り注ぐPAR強度を元に、算出するようにした）。

●定着シナリオのパラメーターEst_year_changeを適用させるシミュレーション年は、これまでのシミュレーション毎の実行年数から、通しの実行年数へと変更した。リスタートする際に設定に注意すること。
（例）Est_year_change=50と設定して100年間のシミュレーションを実行させると、シミュレーション50年目以降から定着条件が変化する。このシミュレーションで生成されたspiunp.txtを読み込んでリスタートした場合、最初から変化した定着条件が適用されてシミュレーションが実行される。

●これまではSUBROUTINE establishで定義されていた、定着に関するパラメーターをparameter.txtで扱うようにした
Est_scenario    (以前サブルーチンで定義されていた'scenario')  
Est_year_change (以前サブルーチンで定義されていた'year_change')
Est_pft_OnOff   (以前サブルーチンで定義されていた'est_switch')
Est_frac_random (以前サブルーチンで定義されていた'frac_random_est')

●SUBROUTINE mainにて、配列変数size_distを用意した。これは仮想林分内の木本を、DBHサイズクラス別、PFT別に集計した値が格納される。現在の設定では、5㎝間隔、最大1mまでの集計を行っている。より詳細な定義は、SUBROUTINE size_class_updateを参照されたい。

●SUBROUTINE mainにて、バイオマス密度を扱う変数を用意した（以下の５種類）。単位は全て「g 乾燥バイオマス／仮想林分」である。これらは、一日間隔で更新される。これらの変数はスピンアップファイルには出力されないが、各種の物理・生理・生態ルーチンを呼び出される前に、これらの変数を更新するルーチンが実行されるので、リスタート後実行の初日の最初より、これら変数には最新の値が格納される。

pool_trunk    木本PFTsの幹・枝・粗根・貯蔵・利用可能バイオマス
pool_leaf     木本PFTsの葉バイオマス
pool_root     木本PFTsの細根バイオマス
pool_grass_up 草本PFTsの地上部・利用可能バイオマス
pool_grass_dn 草本PFTsの地下部・貯蔵バイオマス

●output.f90に、新たにSUBROUTINE output_ld_verticalを追加した。これは鉛直方向の木本PFT葉群分布を出力するサブルーチンで、結果はoutput_ld_vertical.txtとして出力される。なお、出力の対象となるPFTや鉛直方向の解像度を変更するためには、コードを直接改造する必要がある。

●PFT固有パラメーターRG_f_suck(1:PFT_no)を導入した。これは、葉群が落ちるときに、その葉群から回収されるバイオマスの比を指定するものである。（現在はいずれのPFTもRG_f_suck=0.0としているので、葉群からのバイオマス回収は行われていない）



****** ver1.31 -> ver1.40 ******
●ver1.40がSato et al (2007)のシミュレーションに掲載されているバージョンである。なお、諸事情により、ver1.20 -> ver1.30で行った幾つかの変更点を元に戻した。元に戻した変更箇所は以下の通りである。

     ～注意！元に戻した変更リストです～
○フェノロジー制御方法(TrBR)
stat_waterが７日間連続で0.5を超えたときにON、NPP（PFT毎の合計）が連続７日間負になった日にOFF。
○フェノロジー制御方法(TeBS)
展葉期→休眠期の切り替え基準を、日長が11時間以下＋土壌温度11℃以下。また、展葉開始日のday of yearが、北半球の場合は(30+緯度)から(130+緯度)まで、南半球の場合は(212-緯度)から(312-緯度)までという条件を付加。
○落葉のさせ方を変更
これまでは、展葉期から休眠期にはいると、全ての葉が一度に落ちるとしていたが、これを休眠期に入ってから２週間かけて徐々に葉が落ちるようにした。
○木本に最大寿命を設定した（パラメーターAGE_max ）。TeBSとBoBSが200年、残りの木本PFTsでは500年と仮定した。
○落葉を開始して以降のNPPは全て貯蔵資源生産に用いられるとした。
○各PFTsのパラメーター変更



****** ver1.30 -> ver1.31 ******
●SEIB-Viewer用にファイル「output.txt」を出力させるようにした。このためサブルーチンoutput_for_viewerを追加した。なお、SEIB-Viewerについては、readme.txtを参照されたい。



****** ver1.20 -> ver1.30 ******
●フェノロジー制御方法を大幅に改変した（※重要！）。
特に展葉期→落葉期の切り替え基準を、新たにArora&Boer(2005)より得た。

○Tropical broad-leaved raingreen(TrBR)
新：stat_waterが７日間連続で0.5を超えたときにON、NPP（PFT毎の合計）が連続７日間負になった日にOFF。
旧：stat_waterの10日間running meanが0.5を超えたときにON、NPP（PFT毎の合計）の10日間running meanが負になった日にOFF。なお、フェノロジーOFFの判別はmetabolic.f90の768行において行っていたが、以下のバグが存在したので報告しておく。
誤 if ( sum(stat_water_RunningRecord(i,1:10) )     > 0.5 ) flag=.true.
正 if ( sum(stat_water_RunningRecord(p,1:10)) / 10 > 0.5 ) flag=.true.

○Templete broad-leaf summar-green trees (TeBS), 展葉期→休眠期の切り替え基準
新：日長が11時間以下＋土壌温度11℃以下。展葉開始日の決定方法は変更しなかったが、結果を安定させるために展葉開始日のday of yearが、北半球の場合は(30+緯度)から(130+緯度)まで、南半球の場合は(212-緯度)から(312-緯度)までという条件を付加した。
旧:日平均気温の10日間running meanが9℃以下、または日平均気温の10日間running mean がcoldest month temperature（最近20年間のrunning mean）よりも５℃以内に近づいた日にOFF。

○Boreal broad-leaf summar-green trees (BoBS), 展葉期→休眠期の切り替え基準
新：土壌温度が2℃以下となった日にOFF。展葉開始日の決定方法は変更しなかったが、結果を安定させるために展葉開始日のday of yearが、北半球の場合は(30+緯度)から(130+緯度)まで、南半球の場合は(212-緯度)から(312-緯度)までという条件を付加した。
旧:日平均気温の10日間running meanが9℃以下、または日平均気温の10日間running mean がcoldest month temperature（最近20年間のrunning mean）よりも５℃以内に近づいた日にOFF。

○Summer green needle-leaf trees (BoNS), 展葉期→休眠期の切り替え基準
新：日平均気温が7日間連続で-5℃以下となった日。
旧：日平均気温の10日間running meanが2℃以下、または日平均気温の10日間running mean がcoldest month temperature（最近20年間のrunning mean）よりも５℃以内に近づいた日。

○草本（TeH,TrH）
新：最適葉面積指数（lai_opt）が連続7日間正であれば展葉期へ入り、連続7日間負であれば休眠期へ入るとした。
旧：最適葉面積指数（laiopt）の14日間移動平均が0.1を超えたときに展葉期へ入り、NPPの10日間移動平均が負になったときに休眠期へ入るとした。

●落葉のさせ方を変更
これまでは、展葉期から休眠期にはいると、全ての葉が一度に落ちるとしていたが、これを休眠期に入ってから2週間かけて徐々に葉が落ちるようにした。

●木本に最大寿命を設定した（パラメーターAGE_max ）。TeBSとBoBSが200年、残りの木本PFTsでは500年と仮定した。

●木本の定着条件を変更
○BoBS
定着できる林床PAR強度を次のように変更した
新：昨年の成長期間における平均が200(μmol photon m-2 s-1)以上
旧：年間平均が800(μmol photon m-2 s-1)以上

○熱帯性と温帯性の常緑樹(TrBE,TeNE,TeBE）
stat_waterの月平均が0.3を下回る期間が半年以上持続した年には、定着できないと仮定した（parameter.txt中のDM_maxの値を変更）。これは熱帯常緑樹の分布範囲を再現するために調整したものであり、今後も変更する可能性がある。

●植物生理モジュールにおける仮定を2点変更。(1)落葉を開始して以降のNPPは全て貯蔵資源生産に用いられるとした、(2)呼吸に必要な資源が足りないときの、バイオマス低下率を従来の3％から1％に変更した。植物の生育に不適な環境下であっても、実際には多くの植物がしぶとく生育しているので、その様子を極力表現できるようにしたのが変更の目的。

●機能追加（※NEW！）
リスタート機能を追加した。使用方法については、readme.txtを参照のこと。

●コード整理
SUBROUTINE leaf_seasonを大幅に書き換え整理した。

●サブルーチンoutput_waterで出力させる、土壌含水量指数の定義を変更。モニター出力している値を変えただけなので、シミュレーションの内容には変更なし。

●上記の諸変更に伴って、各PFTsのパラメーターを再推定した。なお、TrBDの最大光合成速度PMAXについては、Wright et al. (2004)のデータセットより得た11.9(μmol/mol/CO2/m2/s)を採用した。



****** ver1.10 -> ver1.20 ******
●ペンマモンティース式におけるパラメータ設定ミスの修正（※重要！）
これまでのバージョンでは、空気比熱の値を間違った単位で入力していた。これまでは、0.2813 Wh kg-1 K-1 としていたが、正しくは1012 J kg-1 K-1 である（但し空気の比熱は湿度の関数なので、これは概算値）。従来のヴァージョンでは、飽差による蒸発散が殆ど起きないため、蒸発散量を過小に評価しいた。これまで流出量を過大に推定していたが、これが一つの原因と思われる。
変更部分 → physics.f90のサブルーチンwaterbudgetの386行と396行

●Litter分解速度の算出におけるバグ修正（※重要！）
SEIB-DGVMにおいてLitter分解速度は、昨年一年間の実蒸発散量（変数：aet）の関数としていたが、このaetがmain.f90において適切に計算されていなかった。これによって、これまでのシミュレーションでは、リターが極端に蓄積してしまっていた。このバグの修正とともに、
旧： 月Litter分解速度 = 年Litter分解速度 / 12.0
としていたのを、正確に
新： 月Litter分解速度 = 1.0 - (1.0-年Litter分解速度)**(1.0/12.0)
に改めた。

●蒸散を起こす土壌レイヤーの優先順位の変更
蒸散される水分は、土壌第１層と第２層から供給される。従来のバージョンでは、この第１層：第２層から給水比率を、根バイオマスの鉛直分布に比例させていた、今バージョンより土壌含水率のより高い層から優先的に生じるとした。このあたりは、特に生理学的な根拠はなく、単純にモデル挙動の調整のために試行錯誤している部分なので、再び変更する可能性がある。
変更部分 → physics.f90のサブルーチンwaterbudgetの591～602行

●stat_water定義の変更
各PFTの水ステータスを定義するパラメーターstat_waterの定義を変更した。従来の定義では、土壌第１層と第２層の含水率に、各層の根バイオマスの鉛直分布比率をかけ合わせていた。このヴァージョンでは、土壌第１層と第２層のいずれか高い方のみで、stat_waterを決定する。このあたりは、特に生理学的な根拠はなく、単純にモデル挙動の調整のために試行錯誤している部分なので、再び変更する可能性がある。以上２点の変更に伴って、パラメーターP_root（各PFT毎の根バイオマス垂直分布を定義）が不要となったため、これを削除した。
変更部分 → main.f90の483～490行、及びP_rootを定義・利用していた複数のファイル。

●土壌表面からの蒸発量を制御する因子c_soilの定義変更
旧： c_soil = 0.0224 * ( pool_w1 / W_sat*Depth1 )^4
新： c_soil = 0.0224 * ( pool_w1 / W_sat*Depth1 )^2
このあたりは、特に物理的根拠があって変更しているわけでなく、モデル挙動を調整するために試行錯誤している部分なので、再び変更する可能性がある。

●仮想パイプを伸ばす高度を変更
各葉群Diskの直達光強度を計算させる際に用いる「仮想パイプ」を伸張させる高度を変更した。これまでは南中高度としていたが、これを南中高度×0.86と設定した。これは、太陽高度と太陽放射強度の日変化を、それぞれSinとSin^2とで近似したときに、太陽高強度を上下２等分にする高度である。
変更部分 → special_calc.f90のサブルーチンdirect_radiationへ、新たなsl_hgt_adj(=0.86*sl_hgt)を定義。

●土壌乾燥度に関連した木本PFT定着条件の変更を次のように変更した。
旧：stat_waterの月平均が連続2ヶ月間、0.5を下回った年には定着できない。
新：熱帯性と温帯性の常緑樹（TrBE, TeNE, TeBE）は、stat_waterの月平均が0.3を下回ることが一度でもあった年には、それらは定着できない。

●フェノロジー計算法の変更
草本PFTについても休眠期→活動期への切り替えに際して、次の条件を与えた：「展葉開始Day of the Year (doy)は、北半球の場合は30+緯度から130+緯度まで、南半球の場合は212-緯度から312-緯度まで」。

●各種パラメーターの再推定
上記の変更に伴って、モデルの挙動が変化したため、各種パラメータを再推定した。

●細かな仕様変更１
これまで外部ファイルparameter.txtで指定していたパラメーターLogging（ログファイルを出力するかどうかのスイッチ）を、module.f90中で指定するようにした。こうしておくと、Logging=0（ログファイルを出力しない設定）となっているときに、「if (Logging=1) then」以下の行を無視してコンパイルしてくれるので、計算速度が上がると聞いたのが理由。もっとも、これはSX系ベクトル型スパコン用コンパイラーでの話なので、他の環境で実行速度が上がるかどうかは不明。
変更ファイル → module.f90, start_point.f90, parameter.txt

●細かな仕様変更２
もともと一地点計算版では使用していなかったパラメーター'Lon_start', 'Lon_end', 'Lat_start', 'Lat_end'を削除した。全球計算でも使用しなくなったのが理由。
変更ファイル → module.f90, start_point.f90, parameter.txt



****** ver1.02 -> ver1.10 ******
●物理モジュールにおける変更点
○変更の骨子
森林生態系における蒸発散量が低すぎるという問題を解決するため、放射と水文に関わる物理スキーム等に変更を加えた。従来のバージョンにおいては、これらのスキームは主に他モデルのパラメタライズを変更せずに取り入れていたが、それらの点を見直した。結果、モデル構造における不自然が修正され、同時に水循環の出力が常識的な範囲に収まった。

○Net radiationを計算する際の植生アルベドを、以前は一律0.20としていたが、森林biomeの時には0.15、草本biomeの時には0.24とした。なお、これらの値は、Jones(1992)より得た。

○ポテンシャル蒸散量とポテンシャル蒸発量を計算するときの、太陽エネルギーの入れ方を正確にした。
旧: 樹冠[地面]が一日に吸収する短波放射量(in Wh m-2 day-1)
= 南中時の樹冠[地面]における純短波放射量(in W m-2)×日長(in hour)

新: 樹冠[地面]が一日に吸収する短波放射量( in Wh m-2 day-1 )
= 南中時の樹冠[地面]における純短波放射量(in W m-2)×日長(in hour)×0.5

ちなみに、0.5=Integrate[ sin^2(t)/PI, {t=0,PI} ]であり、一日の太陽高強度変化をsin^2で近似した際に、地表面が受ける一日の積算太陽放射量を求める際の係数である。この変更に伴って、これまで、実蒸発量を計算する際に掛け合わせていた無次元の調整係数Kev(==0.333)を削除した。

○太陽放射が大気で減衰される際の経験式を変更した。

旧：Blackの経験式
生態圏に入る短波放射 = 成層圏の短波放射×(0.803-0.34*cloud-0.458*cloud*cloud)

新：NCEP/NCARの再解析データを元に、共同研究者の伊藤が作成した経験式
生態圏に入る短波放射 = 成層圏の短波放射×(0.8964-0.5392*cloud)

なお、cloudは雲度である。従来の式では、地表面の放射エネルギーを過小評価する傾向があったが、これが改善された。ただし、いずれの式も経験式に過ぎず、ただ一種類の経験式を全ての気候区に適用するという今の構造には無理がある。したがって、地表面に入る短波放射量が気象モデル（GCM）から出力されている場合は、上記のような経験式を使わずに、その値を直接入力するべきである。

○空力学的コンダクタンス(c_aero)の算出方法を変更した。
旧：     c_aero = u×(k^2) / ( ln(10.0)     )^2
新：     c_aero = u×(k^2) / ( ln((z-d)/z0) )^2
ただし、
k     Karman定数 (0.41)
u     植被上z(m)における風速 (m s-1)
d     地面修正量(zero plane displacement) (0.78*hとした)
z0     粗度長(roughness length) (0.07*hとした)
h     植被の高さ(m)。森林biomeでは10m、それ以外のbiomeでは1mと仮定した。
z     風速を測定した高さ(m)。利用した風速データの定義よりz=h+10。

よって、森林BIOMEでは c_aero = u×(k^2) / ln( 17.4)^2
それ以外のBIOMEでは   c_aero = u×(k^2) / ln(146.0)^2

なお、d(地面修正量)とz0(粗度長)のパラメタライズは服部(1985)より得た。この辺りの数値は、水収支に強く影響する。したがって、より適切なシミュレートのためには、それなりのコード改変が必要とされるだろう。

○土壌コンダクタンス（c_soil）の定義を次のように変更した。
  c_soil = 0.0224 * ( pool_w1 / W_sat*Depth1 )^4
この式は、ある程度乾燥した土壌からは、なかなか蒸発がおきない構造となるように調整しただけであり、物理的な根拠はない。現在のシミュレートでは、入力する気象データとして、一辺200km程度のグリッドにおける10年間の平均値を用いており、したがって毎日少量の降水がシトシト降っている状況となっている。このような場合、物理的に「正しい」水文モデルでは、どうしても地表面からの蒸発量が大きくなりすぎてしまう、というのが、この扱いを採用した理由である。したがって、入力する気象データの種類に応じて、c_soilの算出方法は適宜変更するべきである。

○遮断蒸発の計算法を、NEILSON(1995)の計算スキームに変更した（これに伴って、遮断蒸発のパラメーター、P_icを削除した）。

●植物生理モジュールにおける変更点
○変更の骨子
乾燥域にまで、熱帯常緑樹が分布してしまい、他方で熱帯雨緑樹が殆ど分布しないという問題点を改善した。また、葉のturnoverの仮定における不自然な点を修正し、各種パラメーターを再度調整した。

○葉のturnover
旧：常緑性として振る舞っている（一年以上前から展葉期に入っている場合）場合のみ、年率TO_fで葉のturnoverが生じる。落葉性として振る舞っている場合には、落葉期に入る際に全ての葉を落とすが、成長期間には葉のturnoverは生じない。

新：常緑性として振る舞っている（一年以上前から展葉期に入っている場合）場合には、年率TO_fで葉のturnoverが生じる。落葉性として振る舞っている場合には、落葉期に入る際に全ての葉を落とす事に加えて、次の年率でdailyのturnoverが生じる：max [0.0 , TO_f - 365/昨年の成長期間日数]。なお、草本PFTにおいて最適LAIを算出する際にも、この補正した葉turnover rateが適用される。

○stat_waterの定義、および光合成速度の土壌含水量依存部分の項(ce_water)を変えた。これに伴って、パラメーターKwater(=0.5)を削除した。

旧：stat_water =       P_root * (pool_w1/Depth1- W_wilt)/(W_fi-W_wilt) +
                (1.0-P_root) * (pool_w2/Depth2- W_wilt)/(W_fi-W_wilt)
   ce_water = stat_water^Kwater

新：stat_water = {P_root*(pool_w1/Depth1) + (1.0-P_root(p))*(pool_w2/Depth2) - W_wilt} / (W_mat-W_wilt), ただしstat_water=0.0～1.0。
   ce_water = stat_water

また、土壌温度が0℃を下回る場合には、stat_waterは0になると仮定した。


○C4草本についても、C3草本同様に、その場所の生育期間における過去20年間の移動平均気温を最適光合成温度とした。ただし、適応気温範囲の上限と下限は、それぞれC3植物の10℃増しとした(すなわち20～40℃の範囲でaccomodationする)。

○Raingreen woody PFTのフェノロジー：
stat_waterの10日間移動平均が0.5を超えた日に展葉期に入り、0.5を下回った日に休眠期に入るとした。なお、結果を安定させるため、これまで同様に展葉期と休眠期はそれぞれ最低60日は持続すると仮定した。

○草本のフェノロジー：
lai_optの14日間移動平均が0.1を超えたときに展葉期に入り、NPPの10日間移動平均が負になったときに休眠期へ入るとした。なお、結果を安定させるため、これまで同様に展葉期と休眠期はそれぞれ最低60日は持続すると仮定した。

○Tropical evergreen woody PFTの定着条件：
これまでの条件に加えて、新たに「stat_waterの月平均が連続２ヶ月間マイナスであった年には定着できない」という条件を付加した。

●以下のパラメーターを再調整した
Pmax、GS_b2、P_establish、ALM1、ALM4、LA_max

●Bug Fix
場所：SUBROUTINE photosynthesis_condition、ce_tmpを算出する部分
症状：気温（tmp_air）が光合成可能な温度範囲を逸脱しても、光飽和時光合成速度（pmax）が0.0になるとは限らなかった。（このバグは、グリーンランドに草が生えているので、これは変だいうことで発見しました）
対処：次の２行を追加
   if ( tmp_air <= Tmin(pft) ) ce_tmp=0.0
   if ( tmp_air >= Tmax(pft) ) ce_tmp=0.0

●文献
○Jones, H.G., 1992. Radiation. In: Jones, H.G., Plants and microclimate, 2nd ed, pp:9-44, Cambridge University press.
○Neilson, R.P., 1995. A model for predicting continental-scale vegetation distribution and water balance. Ecol. Appl. 5, 362-385.
○服部重昭, 1985. 蒸発散量推定式の誘導過程と林分への適用における問題点, 林誌研報 332.



****** ver1.01 -> ver1.02 ******
spatial_calc.f90の190行目からのループの計算内容を改善しました。プログラム全体で、一割前後は演算速度が上がったはずです。なお、実数演算の部分をいじりましたので、以前とは計算結果が若干異なってくるはずです。あらかじめご承知置き下さい。



****** ver1.00 -> ver1.01 ******
・計算内容は以前のバージョンと全て同じです。

・プログラム中の変数名が、投稿中論文や日本語仕様書のそれと異なっていましたので、これをなるべく一致させました。

・これまで、Plant Functional Typeは10種類のみを扱うようにコードが書かれていました。このバージョンからは、module.f90の7行目、PFT_noに代入する数字を変えることで、これを自由に変更することができます。なお、PFTの数を増やした際には、parameter.txt中のパラメーターの個数も、同様に増やす必要があります。ただし、C3とC4草本PFTは、それぞれ必ず１種類ずつ設定してやる必要があります。つまり、現状のコードでは草本PFTの数を増やしも減らしもできません。また、これまではC3草本のPFT番号は9、C4草本のPFT番号は10と固定していましたが、これも自動でparameter.txt中のパラメーターLife_typeの設定に応じて、自動的に設定されるようになりました。

・その他、細かな改変（例：出力ファイルのopen文をoutputからmainへ、namelist文をmoduleからstart_pointへ、それぞれ移動）。 
